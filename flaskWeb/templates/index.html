<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘é¡µç‰ˆç…§ç‰‡æµè§ˆå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—ä½“ */
        :root { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto space-y-8">
        <h1 class="text-4xl font-extrabold text-gray-900 text-center">ç½‘é¡µç‰ˆç…§ç‰‡æµè§ˆå™¨</h1>

        <!-- 1. ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ -->
        <div id="upload-section" class="bg-white p-6 shadow-xl rounded-xl border border-blue-100">
            <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-2">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡</h2>
            <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- æ–‡ä»¶é€‰æ‹© -->
                    <div>
                        <label for="photo" class="block text-sm font-medium text-gray-700">ç…§ç‰‡æ–‡ä»¶</label>
                        <input type="file" id="photo" name="photo" accept="image/jpeg" required 
                               class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition duration-150">
                    </div>
                    
                    <!-- æ‹æ‘„æ—¶é—´ -->
                    <div>
                        <label for="capture_time" class="block text-sm font-medium text-gray-700">æ‹æ‘„æ—¶é—´ (å¯é€‰ï¼ŒEXIFä¼˜å…ˆ)</label>
                        <input type="datetime-local" id="capture_time" name="capture_time" 
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        <p class="text-xs text-gray-500 mt-1">æ ¼å¼ï¼šå¹´-æœˆ-æ—¥ æ—¶:åˆ† (EXIFä¼˜å…ˆ)</p>
                    </div>

                    <!-- æ‹æ‘„åœ°ç‚¹ -->
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700">æ‹æ‘„åœ°ç‚¹ (å¯é€‰)</label>
                        <input type="text" id="location" name="location" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬æ•…å®«" 
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                </div>

                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                    ä¸Šä¼ å¹¶ä¿å­˜å…ƒæ•°æ®
                </button>
            </form>
        </div>

        <!-- 2. æŸ¥è¯¢æ¡ä»¶è®¾ç½®åŒºåŸŸ -->
        <div id="query-section" class="bg-white p-6 shadow-xl rounded-xl border border-purple-100">
            <h2 class="text-2xl font-semibold text-purple-700 mb-4 border-b pb-2">ğŸ” ç…§ç‰‡æŸ¥è¯¢ä¸æ’åº</h2>
            <form id="query-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- åœ°ç‚¹è¿‡æ»¤ -->
                    <div>
                        <label for="location-filter" class="block text-sm font-medium text-gray-700">åœ°ç‚¹å…³é”®è¯</label>
                        <input type="text" id="location-filter" placeholder="åœ°ç‚¹åŒ…å«çš„æ–‡å­—"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                    </div>
                    
                    <!-- å¼€å§‹æ—¶é—´ -->
                    <div>
                        <label for="start-time-filter" class="block text-sm font-medium text-gray-700">æ‹æ‘„å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" id="start-time-filter"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                    </div>

                    <!-- ç»“æŸæ—¶é—´ -->
                    <div>
                        <label for="end-time-filter" class="block text-sm font-medium text-gray-700">æ‹æ‘„ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" id="end-time-filter"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                    </div>
                    
                    <!-- æ’åºæ–¹å¼ -->
                    <div>
                        <label for="sort-order" class="block text-sm font-medium text-gray-700">æ’åºæ–¹å¼ (æŒ‰æ—¶é—´)</label>
                        <select id="sort-order"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2 bg-white">
                            <option value="asc">é¡ºåº (æœ€æ—©åœ¨å‰)</option>
                            <option value="desc">å€’åº (æœ€æ–°åœ¨å‰)</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150">
                    åº”ç”¨æŸ¥è¯¢æ¡ä»¶
                </button>
                <button type="button" id="reset-query" class="w-full py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">
                    é‡ç½®æŸ¥è¯¢
                </button>
            </form>
        </div>
        
        <!-- 3. ç…§ç‰‡å±•ç¤ºåŒºåŸŸ -->
        <div id="photo-viewer" class="bg-white p-6 shadow-xl rounded-xl border border-green-100 space-y-4 text-center">
            <h2 class="text-2xl font-semibold text-green-700 mb-4 border-b pb-2">ğŸ–¼ï¸ ç…§ç‰‡å±•ç¤º</h2>
            
            <div id="photo-display-container" class="relative">
                <img id="current-photo" src="https://placehold.co/800x600/E5E7EB/6B7280?text=ä¸Šä¼ ç…§ç‰‡å¼€å§‹æµè§ˆ" alt="å½“å‰ç…§ç‰‡" 
                     class="w-full max-h-[60vh] object-contain rounded-lg shadow-lg mx-auto">
                
                <div id="photo-metadata" class="mt-4 text-gray-600 space-y-1">
                    <p>æ–‡ä»¶å: <span id="meta-filename" class="font-mono text-xs text-gray-500">N/A</span></p>
                    <p>åœ°ç‚¹: <span id="meta-location" class="font-bold text-gray-800">N/A</span></p>
                    <p>æ—¶é—´: <span id="meta-time" class="font-bold text-gray-800">N/A</span></p>
                    <p class="text-sm font-medium">
                        å½“å‰ç…§ç‰‡: <span id="current-index" class="text-green-600">0</span> / <span id="total-count">0</span>
                    </p>
                </div>
            </div>

            <!-- å¯¼èˆªæŒ‰é’® -->
            <div class="flex justify-center space-x-4 pt-4">
                <button id="prev-btn" disabled class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 disabled:opacity-50 transition duration-150">
                    &#9664; ä¸Šä¸€å¼ 
                </button>
                <button id="next-btn" disabled class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 disabled:opacity-50 transition duration-150">
                    ä¸‹ä¸€å¼  &#9654;
                </button>
            </div>
        </div>
        
        <!-- æç¤ºæ¶ˆæ¯ -->
        <div id="message-box" class="fixed bottom-4 right-4 p-3 bg-red-500 text-white rounded-lg shadow-xl hidden"></div>
        
    </div>

    <script>
        // JavaScript é€»è¾‘
        const queryForm = document.getElementById('query-form');
        const resetQueryBtn = document.getElementById('reset-query');
        const currentPhoto = document.getElementById('current-photo');
        const metaFilename = document.getElementById('meta-filename');
        const metaLocation = document.getElementById('meta-location');
        const metaTime = document.getElementById('meta-time');
        const currentIndexSpan = document.getElementById('current-index');
        const totalCountSpan = document.getElementById('total-count');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const messageBox = document.getElementById('message-box');
        const captureTimeInput = document.getElementById('capture_time'); // ä¸Šä¼ è¡¨å•çš„æ—¶é—´è¾“å…¥æ¡†
        const photoFileInput = document.getElementById('photo'); // æ–‡ä»¶é€‰æ‹©è¾“å…¥æ¡†

        let photos = []; // å­˜å‚¨å½“å‰æŸ¥è¯¢ç»“æœçš„ç…§ç‰‡åˆ—è¡¨
        let currentIndex = 0; // å½“å‰æ˜¾ç¤ºçš„ç…§ç‰‡ç´¢å¼•
        
        /**
         * æ ¼å¼åŒ– Date å¯¹è±¡ä¸º datetime-local è¾“å…¥æ¡†æ‰€éœ€çš„ YYYY-MM-DDTHH:MM æ ¼å¼ã€‚
         * @param {Date} date è¦è®¾ç½®çš„æ—¥æœŸå¯¹è±¡ã€‚
         * @returns {string} æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²ã€‚
         */
        function formatDateToInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        /**
         * æ ¼å¼åŒ– EXIF æ—¶é—´å­—ç¬¦ä¸² (YYYY:MM:DD HH:MM:SS) ä¸º datetime-local è¾“å…¥æ¡†æ‰€éœ€çš„ YYYY-MM-DDTHH:MM æ ¼å¼ã€‚
         * @param {string} exifTimeString EXIF åŸå§‹æ—¶é—´å­—ç¬¦ä¸²ã€‚
         * @returns {string} æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²ã€‚
         */
        function formatExifTime(exifTimeString) {
            if (!exifTimeString || exifTimeString.length < 16) return '';
            // YYYY:MM:DD HH:MM:SS -> YYYY-MM-DDTHH:MM
            const [datePart, timePart] = exifTimeString.split(' ');
            const formattedDate = datePart.replace(/:/g, '-');
            const formattedTime = timePart.substring(0, 5); // Take only HH:MM
            return `${formattedDate}T${formattedTime}`;
        }
        
        /**
         * å°è¯•ä» JPEG æ–‡ä»¶çš„ ArrayBuffer ä¸­æå– EXIF æ‹æ‘„æ—¶é—´ (DateTimeOriginal)ã€‚
         * æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„å®ç°ï¼Œä»…æŸ¥æ‰¾åŸå§‹æ—¶é—´å­—ç¬¦ä¸²ï¼Œä¸è¿›è¡Œå®Œæ•´çš„ TIFF/EXIF è§£æã€‚
         * * @param {ArrayBuffer} arrayBuffer æ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®ã€‚
         * @returns {string | null} EXIF åŸå§‹æ—¶é—´å­—ç¬¦ä¸² (YYYY:MM:DD HH:MM:SS) æˆ– nullã€‚
         */
        function getExifDateTime(arrayBuffer) {
            const maxSearchLength = Math.min(arrayBuffer.byteLength, 65536); // é™åˆ¶åœ¨æ–‡ä»¶å‰64KB
            // ä½¿ç”¨ TextDecoder æ‰«ææ•°æ®
            const decoder = new TextDecoder('ascii');
            
            // æ‰«æç¼“å†²åŒºæŸ¥æ‰¾EXIFæ—¥æœŸå­—ç¬¦ä¸²æ ¼å¼: "YYYY:MM:DD HH:MM:SS"
            for (let i = 0; i < maxSearchLength - 19; i += 1) {
                // è§£ç ä¸€ä¸ªå°ç‰‡æ®µ
                // è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªé«˜æ•ˆçš„å¯å‘å¼æ–¹æ³•ï¼Œç›´æ¥åœ¨ ASCII æ–‡æœ¬ä¸­æœç´¢æ—¶é—´æˆ³æ ¼å¼
                try {
                    const subArray = new Uint8Array(arrayBuffer, i, 20);
                    const rawText = decoder.decode(subArray);
                    
                    // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… YYYY:MM:DD HH:MM:SS æ ¼å¼
                    const match = rawText.match(/(\d{4}:\d{2}:\d{2} \d{2}:\d{2}:\d{2})/);
                    if (match) {
                        return match[1];
                    }
                } catch(e) {
                    // å¿½ç•¥è§£ç é”™è¯¯ï¼Œç»§ç»­æœç´¢
                }
            }
            
            return null; // æœªæ‰¾åˆ°
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(text, isError = false, duration = 3000) {
            messageBox.textContent = text;
            messageBox.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl ${isError ? 'bg-red-500' : 'bg-green-500'} block`;
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }

        /**
         * å¤„ç†æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼Œå°è¯•æå– EXIF æ‹æ‘„æ—¶é—´ã€‚
         */
        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) {
                captureTimeInput.value = formatDateToInput(new Date()); // å¦‚æœæ–‡ä»¶è¢«æ¸…é™¤ï¼Œåˆ™é‡æ–°è®¾ç½®å›å½“å‰æ—¶é—´
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹æ˜¯å¦å¯èƒ½æ˜¯ JPEG (é€šå¸¸åªæœ‰ JPEG åŒ…å« EXIF)
            if (!file.type.match('image/jpeg')) {
                const fileDate = new Date(file.lastModified);
                captureTimeInput.value = formatDateToInput(fileDate);
                showMessage('é JPEG æ–‡ä»¶ï¼Œå·²ä½¿ç”¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´é¢„å¡«å……ã€‚', false, 4000);
                return;
            }


            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                let foundTime = null;
                
                // 1. å°è¯•ä» EXIF æ•°æ®ä¸­æå–æ—¶é—´
                try {
                    foundTime = getExifDateTime(arrayBuffer);
                } catch (error) {
                    // å¿½ç•¥é”™è¯¯ï¼Œå›é€€åˆ°æ–‡ä»¶ä¿®æ”¹æ—¶é—´
                    console.error("EXIF æå–å°è¯•å¤±è´¥:", error);
                }
                
                let timeToSet;
                let message;

                if (foundTime) {
                    // å¦‚æœæ‰¾åˆ°äº† EXIF æ—¶é—´
                    timeToSet = formatExifTime(foundTime);
                    message = 'å·²ä» EXIF æ•°æ®ä¸­æå–æ‹æ‘„æ—¶é—´å¹¶é¢„å¡«å……ã€‚';
                } else {
                    // 2. EXIF æå–å¤±è´¥ï¼Œå›é€€åˆ°æ–‡ä»¶ä¿®æ”¹æ—¶é—´
                    const fileDate = new Date(file.lastModified);
                    timeToSet = formatDateToInput(fileDate);
                    message = 'æœªæ‰¾åˆ° EXIF æ—¶é—´æˆ–æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œå·²ä½¿ç”¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´é¢„å¡«å……ã€‚';
                }
                
                captureTimeInput.value = timeToSet;
                showMessage(message, false, 4000); 
            };
            
            // å¼€å§‹è¯»å–æ–‡ä»¶çš„å‰ 64KB (é€šå¸¸è¶³å¤ŸåŒ…å« EXIF æ•°æ®)
            const blob = file.slice(0, 65536);
            reader.readAsArrayBuffer(blob);
        }
        
        // ç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶
        photoFileInput.addEventListener('change', handleFileChange);

        // æ›´æ–°ç…§ç‰‡å±•ç¤º
        function updatePhotoDisplay() {
            if (photos.length === 0) {
                currentPhoto.src = "https://placehold.co/800x600/E5E7EB/6B7280?text=æœªæ‰¾åˆ°åŒ¹é…çš„ç…§ç‰‡";
                metaFilename.textContent = 'N/A';
                metaLocation.textContent = 'N/A';
                metaTime.textContent = 'N/A';
                currentIndexSpan.textContent = 0;
                totalCountSpan.textContent = 0;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }

            if (currentIndex < 0 || currentIndex >= photos.length) {
                currentIndex = 0; 
            }

            const photo = photos[currentIndex];
            currentPhoto.src = photo.path;
            currentPhoto.onerror = function() {
                currentPhoto.src = "https://placehold.co/800x600/FEE2E2/EF4444?text=å›¾ç‰‡æ–‡ä»¶æŸåæˆ–ä¸¢å¤±";
            };

            metaFilename.textContent = photo.filename;
            metaLocation.textContent = photo.location;
            metaTime.textContent = photo.time.replace('T', ' '); 
            
            currentIndexSpan.textContent = currentIndex + 1;
            totalCountSpan.textContent = photos.length;

            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === photos.length - 1;
        }

        // ç¿»é¡µé€»è¾‘
        function navigate(direction) {
            if (photos.length === 0) return;
            
            let newIndex = currentIndex + direction;
            
            if (newIndex >= 0 && newIndex < photos.length) {
                currentIndex = newIndex;
                updatePhotoDisplay();
            }
        }

        // ç»‘å®šå¯¼èˆªäº‹ä»¶
        prevBtn.addEventListener('click', () => navigate(-1));
        nextBtn.addEventListener('click', () => navigate(1));

        // å¼‚æ­¥è·å–å’Œè¿‡æ»¤ç…§ç‰‡æ•°æ®
        async function fetchPhotos(params = {}) {
            const url = new URL('/api/photos', window.location.origin);
            Object.keys(params).forEach(key => {
                if (params[key]) {
                    url.searchParams.append(key, params[key]);
                }
            });

            try {
                const response = await fetch(url.toString());
                if (!response.ok) {
                    throw new Error(`æŸ¥è¯¢ç…§ç‰‡å¤±è´¥, çŠ¶æ€ç : ${response.status}`);
                }
                const data = await response.json();
                photos = data;
                currentIndex = 0; 
                updatePhotoDisplay();
                
                if (data.length > 0) {
                    showMessage(`æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${data.length} å¼ ç…§ç‰‡ã€‚`);
                } else {
                    showMessage('æœªæ‰¾åˆ°åŒ¹é…çš„ç…§ç‰‡ã€‚è¯·å°è¯•æ”¾æ¾æŸ¥è¯¢æ¡ä»¶ã€‚', true);
                }

            } catch (error) {
                console.error('Error fetching photos:', error);
                showMessage(`é”™è¯¯: ${error.message}`, true);
                photos = [];
                currentIndex = 0;
                updatePhotoDisplay();
            }
        }

        // ç»‘å®šæŸ¥è¯¢è¡¨å•æäº¤äº‹ä»¶
        queryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const location = document.getElementById('location-filter').value;
            const startTime = document.getElementById('start-time-filter').value;
            const endTime = document.getElementById('end-time-filter').value;
            const sortOrder = document.getElementById('sort-order').value;

            const params = {
                location: location,
                start_time: startTime,
                end_time: endTime,
                sort_order: sortOrder
            };

            fetchPhotos(params);
        });

        // ç»‘å®šé‡ç½®æŒ‰é’®äº‹ä»¶
        resetQueryBtn.addEventListener('click', () => {
            document.getElementById('location-filter').value = '';
            document.getElementById('start-time-filter').value = '';
            document.getElementById('end-time-filter').value = '';
            document.getElementById('sort-order').value = 'asc';
            fetchPhotos(); // é‡æ–°åŠ è½½æ‰€æœ‰ç…§ç‰‡
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            captureTimeInput.value = formatDateToInput(new Date()); // é¡µé¢åŠ è½½æ—¶ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰æ—¶é—´
            fetchPhotos(); // ç«‹å³åŠ è½½æ‰€æœ‰ç…§ç‰‡
        });
        
    </script>
</body>
</html>